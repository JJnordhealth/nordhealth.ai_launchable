---
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import CookieBanner from '../components/CookieBanner.astro';
import type { Lang } from '../i18n';
import '../styles/global.css';

interface Props {
  title: string;
  description: string;
  lang: Lang;
  t: any;
  canonicalPath?: string;
  headerVariant?: 'dark' | 'light';
  activePage?: string;
  bodyClass?: string;
}

const { title, description, lang, t, canonicalPath = '', headerVariant = 'dark', activePage = '', bodyClass = '' } = Astro.props;
const canonicalUrl = `https://nordhealth.ai/nora/${lang}/${canonicalPath}`;
const base = import.meta.env.BASE_URL.replace(/\/$/, '');
---

<!doctype html>
<html lang={lang}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- SEO Meta Tags -->
    <title>{title}</title>
    <meta name="description" content={description} />
    <link rel="canonical" href={canonicalUrl} />
    <link rel="alternate" hreflang="en" href={`https://nordhealth.ai/nora/en/${canonicalPath}`} />
    <link rel="alternate" hreflang="fi" href={`https://nordhealth.ai/nora/fi/${canonicalPath}`} />
    <link rel="alternate" hreflang="nb" href={`https://nordhealth.ai/nora/no/${canonicalPath}`} />
    <link rel="alternate" hreflang="da" href={`https://nordhealth.ai/nora/dk/${canonicalPath}`} />
    <link rel="alternate" hreflang="x-default" href={`https://nordhealth.ai/nora/en/${canonicalPath}`} />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content="https://nordhealth.ai/nora/fi/assets/images/nora-og-image.png" />
    <meta property="og:locale" content={t.locale} />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content={canonicalUrl} />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content="https://nordhealth.ai/nora/fi/assets/images/nora-og-image.png" />

    <!-- Analytics - loaded conditionally after cookie consent -->
    <script is:inline>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}

      function loadGoogleAnalytics() {
        if (document.getElementById('ga-script')) return;
        var script = document.createElement('script');
        script.id = 'ga-script';
        script.async = true;
        script.src = 'https://www.googletagmanager.com/gtag/js?id=G-C4CCK9KL36';
        document.head.appendChild(script);
        gtag('js', new Date());
        gtag('config', 'G-C4CCK9KL36');
      }

      function loadHubSpot() {
        if (document.getElementById('hs-script-loader')) return;
        var script = document.createElement('script');
        script.id = 'hs-script-loader';
        script.async = true;
        script.defer = true;
        script.src = '//js-eu1.hs-scripts.com/144062425.js';
        document.head.appendChild(script);
      }

      function loadAnalytics() {
        loadGoogleAnalytics();
        loadHubSpot();
      }

      try {
        if (localStorage.getItem('cookieConsent') === 'accepted') {
          loadAnalytics();
        }
      } catch (e) {
        // localStorage blocked - analytics won't load until consent given
      }
    </script>

    <link rel="icon" type="image/svg+xml" href={`${base}/favicon.svg`} />

    <!-- Schema.org Organization -->
    <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "Organization",
      "name": "Nordhealth",
      "legalName": "Nordhealth International Oy",
      "url": "https://nordhealth.com",
      "logo": "https://nordhealth.com/images/nordhealth-logo.svg",
      "description": "Nordhealth is a leading healthcare SaaS company providing software solutions for therapy and veterinary professionals across the Nordics.",
      "foundingDate": "2001",
      "foundingLocation": {
        "@type": "Place",
        "name": "Helsinki, Finland"
      },
      "address": {
        "@type": "PostalAddress",
        "addressLocality": "Helsinki",
        "addressCountry": "FI"
      },
      "sameAs": [
        "https://www.linkedin.com/company/nordhealth"
      ]
    })} />

    <!-- Schema.org WebSite -->
    <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "WebSite",
      "name": "Nordhealth Nora",
      "alternateName": "Nora AI Documentation",
      "url": "https://nordhealth.ai/nora/",
      "inLanguage": [lang === 'no' ? 'nb' : lang === 'dk' ? 'da' : lang],
      "publisher": {
        "@type": "Corporation",
        "name": "Nordhealth"
      },
      "potentialAction": {
        "@type": "SearchAction",
        "target": {
          "@type": "EntryPoint",
          "urlTemplate": "https://nordhealth.ai/nora/en/?q={search_term_string}"
        },
        "query-input": "required name=search_term_string"
      }
    })} />

    <!-- Schema.org MedicalWebPage -->
    <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "MedicalWebPage",
      "name": title,
      "description": description,
      "url": canonicalUrl,
      "inLanguage": lang === 'no' ? 'nb' : lang === 'dk' ? 'da' : lang,
      "medicalAudience": {
        "@type": "MedicalAudience",
        "audienceType": "Clinician",
        "healthCondition": {
          "@type": "MedicalCondition",
          "name": "Clinical Documentation"
        }
      },
      "specialty": [
        "General Practice",
        "Psychotherapy",
        "Physiotherapy",
        "Speech Therapy"
      ],
      "mainContentOfPage": {
        "@type": "WebPageElement",
        "cssSelector": "main, .hero, .features"
      },
      "datePublished": "2024-01-01",
      "dateModified": new Date().toISOString().split('T')[0]
    })} />

    <!-- Schema.org SoftwareApplication -->
    <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "Nordhealth Nora",
      "alternateName": "Nora AI",
      "applicationCategory": "HealthApplication",
      "applicationSubCategory": "Clinical Documentation Software",
      "operatingSystem": "Web, iOS, Android",
      "description": description,
      "url": canonicalUrl,
      "screenshot": "https://nordhealth.ai/nora/images/hero_general-practitioners_fi.png",
      "softwareVersion": "2.0",
      "releaseNotes": "AI-powered clinical documentation for healthcare professionals",
      "author": {
        "@type": "Corporation",
        "name": "Nordhealth",
        "url": "https://nordhealth.com"
      },
      "provider": {
        "@type": "Corporation",
        "name": "Nordhealth"
      },
      "offers": {
        "@type": "AggregateOffer",
        "priceCurrency": lang === 'no' ? "NOK" : lang === 'dk' ? "DKK" : "EUR",
        "lowPrice": lang === 'no' ? "1035" : lang === 'dk' ? "499" : "39",
        "highPrice": lang === 'no' ? "1295" : lang === 'dk' ? "599" : "89",
        "offerCount": 3,
        "availability": "https://schema.org/InStock"
      },
      "aggregateRating": {
        "@type": "AggregateRating",
        "ratingValue": "4.8",
        "bestRating": "5",
        "worstRating": "1",
        "ratingCount": "30000",
        "reviewCount": "30000"
      },
      "featureList": [
        "GDPR-compliant & EU-hosted",
        "Session transcription",
        "Live dictation",
        "AI-powered note formatting",
        "Private notes section"
      ],
      "permissions": "No patient data stored for AI training",
      "memoryRequirements": "Web-based, no installation required",
      "countriesSupported": ["FI", "NO", "DK", "SE", "DE"]
    })} />

    <!-- Schema.org BreadcrumbList -->
    <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "BreadcrumbList",
      "itemListElement": [
        {
          "@type": "ListItem",
          "position": 1,
          "name": "Nordhealth",
          "item": "https://nordhealth.com"
        },
        {
          "@type": "ListItem",
          "position": 2,
          "name": "Nora",
          "item": `https://nordhealth.ai/nora/${lang}/`
        },
        ...(canonicalPath ? [{
          "@type": "ListItem",
          "position": 3,
          "name": canonicalPath.charAt(0).toUpperCase() + canonicalPath.slice(1),
          "item": canonicalUrl
        }] : [])
      ]
    })} />
  </head>

  <body class={bodyClass}>
    <Header lang={lang} t={t} variant={headerVariant} activePage={activePage} />

    <slot />

    <Footer lang={lang} t={t} />

    <!-- Demo Modal -->
    <div class="modal-overlay" id="demoModal">
      <div class="modal-content">
        <button class="modal-close" aria-label="Close modal">&times;</button>
        <div class="modal-body">
          <div class="hs-form-frame" data-region="eu1" data-form-id={t.hubspotFormId} data-portal-id="144062425"></div>
        </div>
      </div>
    </div>

    <script is:inline define:vars={{ base }}>
      var s = document.createElement('script');
      s.src = base + '/js/main.js';
      document.body.appendChild(s);
    </script>

    <!-- i18n Dynamic Override Script -->
    <script is:inline define:vars={{ lang }}>
      (function() {
        // Fetch and apply i18n overrides from CMS
        fetch('/api/i18n/' + lang)
          .then(function(r) { return r.json(); })
          .then(function(data) {
            if (!data.overrides || !data.overrides.length) return;

            // Build a map of overrides
            var overrides = {};
            data.overrides.forEach(function(o) {
              overrides[o.key_path] = o.value;
            });

            // Find and update elements with data-i18n attribute
            document.querySelectorAll('[data-i18n]').forEach(function(el) {
              var key = el.getAttribute('data-i18n');
              if (overrides[key] !== undefined) {
                if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                  el.value = overrides[key];
                } else {
                  el.innerHTML = overrides[key];
                }
              }
            });
          })
          .catch(function(err) {
            // Silently fail - static content remains
          });
      })();
    </script>

    <CookieBanner lang={lang} t={t} />
  </body>
</html>
